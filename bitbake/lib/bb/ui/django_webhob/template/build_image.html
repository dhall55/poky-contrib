<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Web hob - Image Creator Demo</title>
<link type="text/css" rel="stylesheet" href="static/css/base.css">
<link type="text/css" rel="stylesheet" href="static/css/main.css">
<script type="text/javascript" src="static/js/jquery.min.js"></script>
<script type="text/javascript" src="static/js/jquery.skygqbox.1.3.js"></script>

<script type="text/javascript">
	var intervalTimer = null;
	var intervalSecond = 1000;

	$(document).ready(function(){
		runEventTimer('getpkgevents', '');
		$('#toggle_pkglog').toggle(function(){
			$('#pkglog').hide();
		},
		function(){
			$('#pkglog').show();
		})
	});

	function runEventTimer(funcName, param){
		if (param==''){
			intervalTimer = setInterval(funcName+"()", intervalSecond);
		}else{
			intervalTimer = setInterval(function(){funcName(action);}, intervalSecond);
		}
	}

	function getpkgevents(){
		jQuery.get('getBuildimageEvents',
		function(data,s){
//			alert(data);
			json = jQuery.parseJSON(data);
			rcp_pct_width = $('#rcp_pct').width();
			if (json.pct) {
				$('#rcp_pct span').css('width',json.pct+'%');
				$('#rcp_pct p').html('Building  percentage: '+json.pct+'%');
				if (json.pct == 100) {
					$('#rcp_pct span').css('width',(rcp_pct_width-6)+'px');
					$('#rcp_pct p').html('Preparing for Tree Data, Waiting~~~~');
				}
			}

			if(json.CommandFailed){
				$('#rcp_pct span').css('width',(rcp_pct_width-6)+'px');
				$('#rcp_pct p').html('<font color=red>Failed</font>');
				clearInterval(intervalTimer);
			}

			if(json.treedata){
				$('#pkg_list').html(json.treedata);
				$('#rcp_pct').hide();
				$('#pkglog').hide();
				if (json.action == 'DONE') {
					clearInterval(intervalTimer);
				}
			}

			//log info
			if(json.building_log){
				$('#pkg_log p').css({"background-color": "#fff"});
				for(var i=0; i<json.building_log.length; i++){
					var innerjson = json.building_log[i];
					var id = (innerjson.package.indexOf('.')!=-1)?innerjson.package.substring(0, innerjson.package.indexOf('.')):innerjson.package;

					if ($('#'+id).length > 0){
						$('#pkg_log p').css({"background-color": "#fff"});
						$('#'+id).append("<p style='background-color:#90ee90'>&nbsp;&nbsp;&nbsp;&nbsp;=>"+innerjson.task+"</p>");
							$('#pkglog').scrollTop($('#'+id).offset().top);
					}else{
						$('#pkg_log').append("<div class='pkglog' id='"+id+"'>Package: "+innerjson.package+"</div>");
						$('#'+id).css({'margin':'5px'}).append("<p style='background-color:#90ee90'>&nbsp;&nbsp;&nbsp;&nbsp;=>"+innerjson.task+"</p>");
							$('#pkglog').scrollTop($('#'+id).offset().top);
					}

				}
			}

			if(json.logRecord_conf){
				$('#logRecord_conf').append('<pre>'+json.logRecord_conf+'</pre>');
			}

			if(json.error){
				for (var i = 0; i < json.error.length; i++) {
					var innerjson = json.error[i];
					$('#pkg_error').css({"background-color": "#ff8500"}).append("<p style='magin:5px; border:1px #ddd solid;'>"+innerjson.error+"</p>");
				}
				clearInterval(intervalTimer);
			}
		},
		'text'
		);
	}

	function getimageevents(){
		jQuery.get('demo/event_buildimage',
			function(data,s){
				//alert(data);
				json = jQuery.parseJSON(data);
				if (json.status) {
					if(json.value.current != json.value.total){
						$('#image_pct').html(json.status+'  percentage: <span style="font-size:30px; font-weight:bold; color:#00f;">'+parseInt((parseInt(json.value.num_of_completed)/parseInt(json.value.total)*100))+'%</span>');
					}else{
						$('#image_pct').html('Prepare Tree Data, Pls Waiting~~~~')
					}
				}else if(json.treedata){
					$('#image_list').html('<span style="font-size:30px; font-weight:bold; color:#00f;">'+json.treedata+'</span>');
					$('#image_pct').hide();
					$('#build_p_i').show();
					if (json.action == 'DONE') {
						clearInterval(intervalTimer);
					}
				}
			},
			'text'
		);
	}

</script>
</head>
<body>

<div class="wrap">
    <!--progress bar-->
    <div class='main_conf' id='rcp_pct' style='display:none_'>
    	<div class="progress-bar">
            <span></span>
            <p></p>
		</div>
    </div>

<div class='main_conf'>
	<div id='Packages' style='display: no_ne'>
		<h2 style='float:right;'><span id='toggle_pkglog'>Building log(toggle):</span></h2>

		<div id='pkglog' style='overflow-y:auto; height:500px;border:1px #ddd solid; clear:both;  padding:5px;'>
			<div id='logRecord_conf'></div>
			<div id='pkg_error'></div>
			<div id='pkg_log'></div>
		</div>
		<div id='pkg_list' style="clear:both;"></div>
	</div>
</div>

	<div class='main_conf' id='build_p_i' style='display:none;'>
		<div style='float:right'>
			<input class='build_button' name="xx" id='build_image' type="button" value="Build Image" title='xxxxx'/>
		</div>
 	</div>
</div>
</body>
</html>