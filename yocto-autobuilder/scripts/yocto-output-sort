#!/bin/bash
BASEPATH=/srv/www/pokylinux.org/output
UPLOADPATH=/srv/www/pokylinux.org/output-upload
INDEX=$BASEPATH/index.html

# Remove all but the last ten builds results
for dir in moblin-incremental-bleeding moblin-incremental; do
	cd $UPLOADPATH/$dir
	for FILE in `find . -type f`; do
	    case $FILE in
	        *.done)
		    ;;
		*complete)
		    ;;
		*gitinfo)
		    ;;
		ipk/*)
		    ;;
		pstage/*)
		    ;;
                *)
	            if [ -e "$FILE.done" ]; then
		        DESTDIR=`dirname $BASEPATH/$dir/$FILE`
			BASENAME=`basename $FILE`
    	                mkdir -p $DESTDIR
			mv $FILE $BASEPATH/$dir/$FILE
			rm $FILE.done
			INFOFILE=`echo $FILE | sed s/$BASENAME/gitinfo/`
			cp $INFOFILE $BASEPATH/$dir/$INFOFILE
		    fi
		    ;;
	    esac
	done

	if [ ! -d "$BASEPATH/$dir" ]; then
	    continue
	fi

        cd $BASEPATH/$dir
	BUILDS=`/home/richard/poky-listversions $BASEPATH/$dir | egrep -v \(ipk\|pstage\) | sed -n '1,10p'`
	TODEL=`/home/richard/poky-listversions $BASEPATH/$dir | egrep -v \(ipk\|pstage\) | sed -n '11,100p'`
	DATA=""

        for build in $BUILDS; do
            LINK="<a href=\"./$dir/$build\">$build</a>"
	    if [ "x$DATA" = "x" ]; then
                DATA="<table align=\"center\" cellpadding=2><tr><td>Latest Build:</td><td>$LINK</td></tr><tr><td>Older Builds:</td><td>"
            else 
	        DATA="$DATA$LINK</td></tr><tr><td></td><td>"
	    fi
        done
        if [ "x$DATA" = "x" ]; then
		DATA="<p>Sorry, no images are currently available</p>"
	else 
        	DATA="$DATA</td></tr></table>"
        fi
        for build in $TODEL; do
                echo "Removing $dir/$build"
                rm -r "$BASEPATH/$dir/$build"
        done

        if [ "$dir" = "moblin-incremental-bleeding" ]; then	
	    BLEEDBUILD=$DATA
	fi
        if [ "$dir" = "moblin-incremental" ]; then	
	    INCBUILD=$DATA
	fi
done
					
#<h2>Moblin 2.0 Images</h2>
#
#<p>These images are built with the Moblin 2.0 release versions of packages. They should 
#therefore be stable but the images are automatically generated and not indivudally tested 
#for quality.</p>


cat > $INDEX << EOF
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>Poky Linux built Moblin Images</title>
</head>
<body>
<h1 align="center">Poky Linux built Moblin Images</h1>
<p>
This page contains links to Moblin like images automatically generated by the 
Poky build system. These images are not production quality and are intended for 
development and testing purposes. Please see <a href="http://pokylinux.org/moblin/">
the Poky website</a> for more information.
</p>

<p>To install an image, download the .hddimage.bz2 file, decompress it using bunzip2
and then transfer it to a USB key using a command like 'dd if=moblin-image.hddimage 
of=/dev/sdi' where /dev/sdi is the location of the USB flash drive. Note that the flash 
drive should be unmounted before transfer takes place.</p>

<h2>Moblin 'Selected' Images</h2>

<p>These images are built with hand selected recent versions of packages which have 
been found to roughly work together. They should therefore be stable but the images
are automatically generated and not indivudally tested for quality.</p>

$INCBUILD


<h2>Moblin 'Bleeding Edge' Images</h2>

<p>These images are built from the latest revisions in the moblin git repositories. 
The images may or may not be fully functional depending on the development work being 
undertaken at the time the images were built.</p>

$BLEEDBUILD

</body>
</html>
EOF

